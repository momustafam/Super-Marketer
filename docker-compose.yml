services:

  sqlagain:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlagain_container
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStrong!Passw0rd"
    ports:
      - "1434:1433"
    volumes:
      - ./data:/data  # ‚úÖ updated to match the expected path
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/1433"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  runsql:
    image: mcr.microsoft.com/mssql-tools
    container_name: init_sql_runner
    depends_on:
      sqlagain:
        condition: service_healthy
    volumes:
      - ./data-engineering:/data-engineering  # ‚úÖ ensure same path as above
    entrypoint: >
      /bin/bash -c "
      echo 'üîÅ Waiting for SQL Server to be ready...' &&
      sleep 15 &&
      echo 'üöÄ Running init_warehouse.sql...' &&
      /opt/mssql-tools/bin/sqlcmd -S sqlagain_container -U SA -P 'YourStrong!Passw0rd' -i /data-engineering/init_warehouse.sql 2>&1 ||
      echo '‚ùå SQL script execution failed.' &&
      echo '‚è≥ Sleeping to allow log collection...' &&
      sleep 10
      "